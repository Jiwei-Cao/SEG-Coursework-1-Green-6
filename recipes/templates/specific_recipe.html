{% extends 'base_content.html' %} {% load widget_tweaks %} {% block content %}
<div class="container my- d-flex justify-content-center">
  <div class="card mb-3 specific_recipe_card">
    <div class="row g-0">
      <div class="col-md-4">
        <img
          src="{% if recipe.img %}{{ recipe.img.url }}{% else %}https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS10b9Qpi-UdObaCziWGF5IuvZFF8bKuQ6bow&s{% endif %}"
          class="img-fluid rounded-start specific-recipe-card-image"
          alt="{{ recipe.title }}"
        />
      </div>
      <div class="col-md-8">
        <div class="card-body d-flex flex-column pb-3">
          <div
            class="d-flex justify-content-between align-items-start mb-0"
          >
            <h4 class="mb-0">{{ recipe.title }}</h4>
            {% if recipe.user != user %}
            <a
              href="{% url 'user_profile' recipe.user.username %}"
              style="text-decoration: none; color: inherit"
            >
              {% endif %}
              <span
                class="d-flex align-items-center gap-2 badge bg-light text-dark recipe-author"
              >
                <small>Author:</small>
                <img
                  src="{{ recipe.user.gravatar }}"
                  class="rounded-circle"
                  style="width: 24px; height: 24px"
                />
                {{ recipe.user }}{% if recipe.user == user %} (YOU){% endif %}
              </span>
              {% if recipe.user != user %}</a>{% endif %} 
              </div>
              {% if user == recipe.user %}
            <div class="d-flex gap-2 ms-auto mt-3 mb-2 align-items-center">
              <a
                href="{% url 'edit_recipe' recipe.id %}"
                class="btn edit-button btn-sm"
                >Edit Recipe</a
              >
              <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal">
                  Delete Recipe
              </button>
            </div>
            <div class="modal fade" id="deleteModal" tabindex="-1">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    Are you sure you want to delete this recipe?
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form method="post" action="{% url 'delete_recipe' recipe.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}
          

          <p class="card-text fst-italic">{{ recipe.description }}</p>
          <div class="d-flex flex-wrap  gap-2 mb-2">
            {% for tag in recipe.tags.all %}
              <span class="badge" style="background-color: {{ tag.colour }};"
>
                {{tag.name}}
              </span>
            {% endfor %}
          </div>

          <p class="card-text rating mb-3">
            <span class="fw-bold">Rating: </span>
            {% for _ in full_stars %}<i class="bi bi-star-fill full"></i>
            {% endfor %} 
            {% if half_star %}
            <i class="bi bi-star-half half"></i>
            {% endif %} 
            {% for _ in empty_stars %}
            <i class="bi bi-star"></i>
            {%endfor %} {{ average_rating }} from {{ rating_count }} rating(s)
          </p>
          <div class = "mb-2">
            <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <b>Ingredients: </b>
                <div class = "d-flex align-items-end justify-content-end gap-2">
                  <a href="?multiplier=1" class="btn quantity-button {% if multiplier == 1 %}active{% endif %}">1x</a>
                  <a href="?multiplier=2" class="btn quantity-button {% if multiplier == 2 %}active{% endif %}">2x</a>
                  <a href="?multiplier=4" class="btn quantity-button {% if multiplier == 4 %}active{% endif %}">4x</a>
                
                {% if user == recipe.user %}
                <a href="{% url 'manage_recipe_ingredient' recipe.pk %}?next={% url 'get_recipe' recipe.id %}" class="btn btn-sm edit-button">
                  Edit
                </a>
                {% endif %}
                </div>
              </div>
              <ul class="list-group list-group-flush">
                {% for ingredient in ingredients %}
                <li class="list-group-item">{{ingredient}}</li>
                {% endfor %}
              </ul>
            </div>
          </div>    
          <div>
            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                  <b>Method</b>

                  <div class="d-flex align-items-center">
                      {% if user == recipe.user %}
                      <a href="{% url 'add_method' recipe.pk %}" class="btn btn-sm edit-button me-2">Edit</a>
                      {% endif %}

                      <button class="btn btn-sm btn-outline-secondary"
                              type="button"
                              data-bs-toggle="collapse"
                              data-bs-target="#methodCollapse"
                              aria-expanded="false"
                              aria-controls="methodCollapse">
                          Show / Hide
                      </button>
                  </div>
              </div>

              <div class="collapse show" id="methodCollapse">
                  <ul class="list-group list-group-flush">
                      {% for step in recipe.method_steps.all %}
                      <li class="list-group-item">
                          <b>{{ step.step_number }}</b>. {{ step.method_text }}
                      </li>
                      {% endfor %}
                  </ul>
              </div>
          </div>


          {% if recipe.user != user %}
          <div class = "mx-2 mt-4">
            <span class="fw-bold small">Your Rating:</span>
            <div class="d-flex flex-column flex-md-row gap-2 mt-1">
              <form method="post" class="rating-form">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="rating_form" />
                <input
                  type="hidden"
                  name="recipe_clicked"
                  value="{{ recipe.id }}"
                />
                <div class="star-rating d-flex flex-wrap flex-md-row gap-2">
                  <div class="d-flex gap-2 mr-3">
                    {% for i in "54321" %} <input type="radio" id="star{{ i }}"
                    name="rating" value="{{ i }}" 
                    {% if user_rating|stringformat:"i" == i %} checked {% endif %} />
                    <label for="star{{ i }}" title="{{ i }} stars">
                      <i class="bi bi-star-fill"></i>
                    </label>
                    {% endfor %}
                  </div>
                  <button type="submit" class="btn submit-button">
                    Submit Rating
                  </button>
                </div>
              </form>
            </div>
            <div class="comment mb-4">
              <form
                action="{% url 'handle_comments' recipe.id %}"
                method="post"
                class="mt-2 gap-2"
              >
                {% csrf_token %}
                <input type="hidden" name="form_type" value="comment_form" />
                <div class="d-flex gap-2">
                  <!--input
                    type="text"
                    name="comment_text"
                    class="form-control flex-grow-1"
                    placeholder="Add a comment"
                  
                  /-->
                
                {% for field in form %}
                  <div class="mb-3">
                    {% if form.is_bound %} 
                    {% if field.errors %} 
                    {% render_field field class="form-control is-invalid" %} 
                    {% else %} 
                    {% render_field field class="form-control is-valid" %} 
                    {% endif %} 
                    {% else %} 
                    {% render_field field class="form-control" %} 
                    {% endif %} 
                    {% if field.help_text %}
                    <div class="form-text">{{ field.help_text }}</div>
                    {% endif %}

                    <div class="invalid-feedback">{{ field.errors }}</div>
                  </div>
                  {% endfor %}



                  <button type="submit" class="btn submit-button">
                    Submit Comment
                  </button>
                </div>
              </form>
            </div>
          </div>
          {% endif %}
          
          <div class="d-flex justify-content-center mt-2 mb-2">
            <a href="{{ previous_url }}" class="btn link-button mb-3"
              >Back</a
            >
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
<div class="container my-4 text-center mt-2">
  <button
    class="btn btn-outline-secondary mb-3"
    type="button"
    data-bs-toggle="collapse"
    data-bs-target="#commentCollapse"
  >
    <!--Show Comments ({{ recipe.comments.all|length }})-->
    Show Comments ({{ recipe_comments_count }})
  </button>
  <div class="collapse" id="commentCollapse">
    {% if recipe.comments.all|length == 0 %}
    <p class="text-muted text-center">
      No comments yet. {% if recipe.user != user %}Be the first to comment!
      {% endif %}
    </p>
    {% else %}
    <div class="d-flex justify-content-center mt-3">
      <div class="card p-3" style="width: 80%">
        {% for comment in recipe.comments.all %}
        <div class="border-bottom py-2">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <span
              class="d-flex align-items-center gap-2 badge bg-light text-dark recipe-author"
            >
              <img
                src="{{ comment.user.gravatar }}"
                class="rounded-circle"
                style="width: 24px; height: 24px"
              />
              {{ comment.user }} {% if comment.user == user %}(YOU){% endif %}
            </span>
            <small class="text-body-secondary"
              >{{ comment.date_published }}</small
            >
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <p class="mb-0">{{ comment.comment }}</p>
            <div class=" d-flex align-items-center">

              <div class="mb-3">
                <button class="btn btn-sm btn-secondary"data-bs-toggle="collapse" data-bs-target="#show-reply-box{{comment.pk}}" aria-expanded="false" aria-controls="show-reply-box">
                  Show Replies ({{comment.replies.all.count}})
                </button>

              </div>

              {% if comment.user == user %}
              <div class="ms-2 mb-3">
              <button type="button" class="btn btn-sm btn-danger delete-button" data-bs-toggle="modal" data-bs-target="#delete-comment-{{comment.pk}}">
                Delete
              </button>
            </div>

              <!-- Modal -->
              <div class="modal fade" id="delete-comment-{{comment.pk}}" tabindex="-1" aria-labelledby="deleteComment" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h1 class="modal-title fs-5" id="exampleModalLabel">Delete Comment: {{comment.comment}}</h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      Are you sure you'd like to permanently delete this comment?
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-sm btn-secondary delete-button" data-bs-dismiss="modal">Close</button>
                      <form action="{% url 'handle_comments' recipe.pk %}"  method="post" class="ms-2">
                        {% csrf_token %}
                        
                        <input type="hidden" name="form_type"  value="delete_comment_form" />
                        <input type="hidden"  name="comment_clicked" value="{{ comment.id }}"  />
                        <button class="btn btn-sm btn-danger delete-button">
                          Delete
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}
          </div>
          </div>

          

        <div class=" justify-content-end collapse" id="show-reply-box{{comment.pk}}">

          

          <div class="row justify-content-end ">

              {% for reply in comment.replies.all %}
        
              <div class=" p-3 col-11">
                  <div class="border-bottom py-2 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                  <span class="d-flex align-items-center gap-2 badge bg-light text-dark recipe-author">
                    <img src="{{ comment.user.gravatar }}"
                      class="rounded-circle"
                      style="width: 24px; height: 24px" />
                    {{ reply.user }} {% if reply.user == user %}(YOU){% endif %}
                  </span>
                  <small class="text-body-secondary"
                    >{{ reply.date_published }}</small>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <p class="mb-0">{{ reply.comment }}</p>
                  {% if reply.user == user %}

              <button type="button" class="btn btn-sm btn-danger delete-button" data-bs-toggle="modal" data-bs-target="#delete-reply-{{reply.pk}}">
                Delete
              </button>


              <!-- Modal -->
              <div class="modal fade" id="delete-reply-{{reply.pk}}" tabindex="-1" aria-labelledby="delete-reply-{{reply.pk}}" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h1 class="modal-title fs-5" id="exampleModalLabel">Delete Comment: {{reply.comment}}</h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      Are you sure you'd like to permanently delete this comment?
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-sm btn-secondary delete-button" data-bs-dismiss="modal">Close</button>
                      <form action="{% url 'handle_comments' recipe.pk %}" method="post" class="ms-2">
                        {% csrf_token %}
          
                        <input type="hidden" name="form_type" value="delete_reply_form" />
                        <input type="hidden" name="parent_comment"value="{{ comment.id }}"/>
                        <input type="hidden" name="reply_clicked" value="{{ reply.id }}"/>
                        <button class="btn btn-sm btn-danger delete-button">
                          Delete
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>


              {% endif %}
                </div>
              </div>
              </div>
              {% endfor %}

            
          </div>
          <div class="row ms-2">
              <form action="{% url 'handle_comments' recipe.pk %}"
                method="post"
                class="ms-2 " id="reply-box{{comment.pk}}" >
                  {% csrf_token %}
                  <input
                  type="hidden"
                  name="form_type"
                  value="reply_comment_form"/>
                <input
                  type="hidden"
                  name="parent_comment"
                  value="{{ comment.id }}"/>

                  <div class="input-group input-group-sm mb-3">
                    <!--input type="text" name="comment_text" class="form-control" placeholder="Reply to {{comment.user}}'s comment" aria-label="reply-text" aria-describedby="basic-addon2"/-->

                    {% for field in form %}
                      <div class="p-2 col-11">
                        {% if form.is_bound %} 
                        {% if field.errors %} 
                        {% render_field field class="form-control is-invalid" %} 
                        {% else %} 
                        {% render_field field class="form-control is-valid" %} 
                        {% endif %} 
                        {% else %} 
                        {% render_field field class="form-control" placeholder="Write a reply..." rows=1 %} 
                        {% endif %} 
                        {% if field.help_text %}
                        <div class="form-text">{{ field.help_text }}</div>
                        {% endif %}

                    <div class="invalid-feedback">{{ field.errors }}</div>
                  </div>
                  {% endfor %}

                    <button class="btn btn-primary" type="submit" id="button-addon2">Submit</button>
                  </div>
              </form>
            
          </div>

     
          </div>
            </div>
            
          
        {% endfor%}
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
